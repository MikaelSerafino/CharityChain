<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Money Flow Tracker</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 900px;
        margin: 30px auto;
        padding: 20px;
        background: #0a0e27;
        color: #fff;
      }
      .container {
        background: #1a1f3a;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }
      h1 {
        color: #00c077;
        margin-bottom: 10px;
      }
      h3 {
        color: #00e68a;
        margin-top: 25px;
        margin-bottom: 15px;
      }
      .info {
        background: rgba(0, 192, 119, 0.1);
        border-left: 4px solid #00c077;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
      }
      .warning {
        background: rgba(255, 152, 0, 0.1);
        border-left: 4px solid #ff9800;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
      }
      .error {
        background: rgba(244, 67, 54, 0.1);
        border-left: 4px solid #f44336;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
      }
      button {
        background: linear-gradient(135deg, #00c077, #00e68a);
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        margin: 5px;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 192, 119, 0.4);
      }
      input {
        width: 100%;
        padding: 12px;
        border: 2px solid #2a3f5f;
        border-radius: 8px;
        background: #0a0e27;
        color: white;
        font-size: 16px;
        margin: 10px 0;
        box-sizing: border-box;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        background: #0a0e27;
        border-radius: 8px;
        font-size: 14px;
        max-height: 600px;
        overflow-y: auto;
      }
      .flow-item {
        background: rgba(0, 192, 119, 0.05);
        border: 1px solid rgba(0, 192, 119, 0.2);
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
      }
      .money-flow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.03);
        padding: 12px;
        border-radius: 6px;
        margin: 8px 0;
      }
      .arrow {
        color: #00e68a;
        font-size: 24px;
        margin: 0 10px;
      }
      .address {
        font-family: "Courier New", monospace;
        background: rgba(0, 0, 0, 0.3);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        word-break: break-all;
      }
      .amount {
        color: #ffd700;
        font-size: 20px;
        font-weight: bold;
      }
      .success {
        color: #00e68a;
        font-weight: bold;
      }
      label {
        display: block;
        margin-top: 15px;
        font-weight: 600;
        color: #00c077;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      th {
        background: rgba(0, 192, 119, 0.2);
        color: #00e68a;
        font-weight: 600;
      }
      tr:hover {
        background: rgba(255, 255, 255, 0.02);
      }
      .link {
        color: #00c077;
        text-decoration: none;
        word-break: break-all;
      }
      .link:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üí∞ Money Flow Tracker</h1>
      <p>
        Track where all the KPGT went: donations ‚Üí platform fees ‚Üí campaign
        owner
      </p>

      <label>Campaign ID:</label>
      <input
        type="number"
        id="campaignId"
        value="0"
        placeholder="Enter campaign ID"
      />

      <label>Contract Address:</label>
      <input
        type="text"
        id="contractAddress"
        value="0x9c566de5f2ba01aabc707636caffa14b11079e19"
        placeholder="0x..."
      />

      <br /><br />
      <button onclick="trackMoneyFlow()">üîç Track Money Flow</button>

      <div id="result"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script>
      const RPC_URL = "https://rpc1.paseo.mandalachain.io";
      const EXPLORER_URL = "https://explorer.mandalachain.io";

      const contractABI = [
        {
          inputs: [
            {
              internalType: "address",
              name: "_platformWallet",
              type: "address",
            },
          ],
          stateMutability: "nonpayable",
          type: "constructor",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "uint256",
              name: "campaignId",
              type: "uint256",
            },
            {
              indexed: false,
              internalType: "string",
              name: "title",
              type: "string",
            },
            {
              indexed: false,
              internalType: "address",
              name: "owner",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "platformFee",
              type: "uint256",
            },
          ],
          name: "CampaignCreated",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "uint256",
              name: "campaignId",
              type: "uint256",
            },
          ],
          name: "CampaignFinished",
          type: "event",
        },
        {
          inputs: [
            {
              internalType: "string",
              name: "_title",
              type: "string",
            },
            {
              internalType: "string",
              name: "_desc",
              type: "string",
            },
            {
              internalType: "string[]",
              name: "_images",
              type: "string[]",
            },
            {
              internalType: "uint256",
              name: "_goal",
              type: "uint256",
            },
            {
              internalType: "string",
              name: "_ownerName",
              type: "string",
            },
            {
              internalType: "string",
              name: "_contact",
              type: "string",
            },
            {
              internalType: "string",
              name: "_category",
              type: "string",
            },
            {
              internalType: "address",
              name: "_wallet",
              type: "address",
            },
          ],
          name: "createCampaign",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "_id",
              type: "uint256",
            },
          ],
          name: "donate",
          outputs: [],
          stateMutability: "payable",
          type: "function",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "uint256",
              name: "campaignId",
              type: "uint256",
            },
            {
              indexed: false,
              internalType: "address",
              name: "donor",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "platformFee",
              type: "uint256",
            },
          ],
          name: "DonationReceived",
          type: "event",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "_id",
              type: "uint256",
            },
          ],
          name: "finishCampaign",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: true,
              internalType: "uint256",
              name: "campaignId",
              type: "uint256",
            },
            {
              indexed: true,
              internalType: "address",
              name: "to",
              type: "address",
            },
            {
              indexed: false,
              internalType: "uint256",
              name: "amount",
              type: "uint256",
            },
          ],
          name: "FundsWithdrawn",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [
            {
              indexed: false,
              internalType: "uint256",
              name: "newFeePercent",
              type: "uint256",
            },
          ],
          name: "PlatformFeeUpdated",
          type: "event",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "_feePercent",
              type: "uint256",
            },
          ],
          name: "updatePlatformFee",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "_id",
              type: "uint256",
            },
          ],
          name: "withdrawFunds",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "campaignCount",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          name: "campaigns",
          outputs: [
            {
              internalType: "uint256",
              name: "id",
              type: "uint256",
            },
            {
              internalType: "string",
              name: "title",
              type: "string",
            },
            {
              internalType: "string",
              name: "description",
              type: "string",
            },
            {
              internalType: "uint256",
              name: "goal",
              type: "uint256",
            },
            {
              internalType: "uint256",
              name: "totalRaised",
              type: "uint256",
            },
            {
              internalType: "uint256",
              name: "platformFee",
              type: "uint256",
            },
            {
              internalType: "string",
              name: "ownerName",
              type: "string",
            },
            {
              internalType: "string",
              name: "ownerContact",
              type: "string",
            },
            {
              internalType: "address",
              name: "ownerWallet",
              type: "address",
            },
            {
              internalType: "bool",
              name: "active",
              type: "bool",
            },
            {
              internalType: "bool",
              name: "finished",
              type: "bool",
            },
            {
              internalType: "uint256",
              name: "createdAt",
              type: "uint256",
            },
            {
              internalType: "string",
              name: "category",
              type: "string",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "_offset",
              type: "uint256",
            },
            {
              internalType: "uint256",
              name: "_limit",
              type: "uint256",
            },
          ],
          name: "getActiveCampaignsPaginated",
          outputs: [
            {
              components: [
                {
                  internalType: "uint256",
                  name: "id",
                  type: "uint256",
                },
                {
                  internalType: "string",
                  name: "title",
                  type: "string",
                },
                {
                  internalType: "string",
                  name: "description",
                  type: "string",
                },
                {
                  internalType: "string[]",
                  name: "imageURLs",
                  type: "string[]",
                },
                {
                  internalType: "uint256",
                  name: "goal",
                  type: "uint256",
                },
                {
                  internalType: "uint256",
                  name: "totalRaised",
                  type: "uint256",
                },
                {
                  internalType: "uint256",
                  name: "platformFee",
                  type: "uint256",
                },
                {
                  internalType: "string",
                  name: "ownerName",
                  type: "string",
                },
                {
                  internalType: "string",
                  name: "ownerContact",
                  type: "string",
                },
                {
                  internalType: "address",
                  name: "ownerWallet",
                  type: "address",
                },
                {
                  internalType: "bool",
                  name: "active",
                  type: "bool",
                },
                {
                  internalType: "bool",
                  name: "finished",
                  type: "bool",
                },
                {
                  internalType: "uint256",
                  name: "createdAt",
                  type: "uint256",
                },
                {
                  internalType: "string",
                  name: "category",
                  type: "string",
                },
              ],
              internalType: "struct Campaign[]",
              name: "",
              type: "tuple[]",
            },
            {
              internalType: "uint256",
              name: "total",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "_offset",
              type: "uint256",
            },
            {
              internalType: "uint256",
              name: "_limit",
              type: "uint256",
            },
          ],
          name: "getAllCampaignsPaginated",
          outputs: [
            {
              components: [
                {
                  internalType: "uint256",
                  name: "id",
                  type: "uint256",
                },
                {
                  internalType: "string",
                  name: "title",
                  type: "string",
                },
                {
                  internalType: "string",
                  name: "description",
                  type: "string",
                },
                {
                  internalType: "string[]",
                  name: "imageURLs",
                  type: "string[]",
                },
                {
                  internalType: "uint256",
                  name: "goal",
                  type: "uint256",
                },
                {
                  internalType: "uint256",
                  name: "totalRaised",
                  type: "uint256",
                },
                {
                  internalType: "uint256",
                  name: "platformFee",
                  type: "uint256",
                },
                {
                  internalType: "string",
                  name: "ownerName",
                  type: "string",
                },
                {
                  internalType: "string",
                  name: "ownerContact",
                  type: "string",
                },
                {
                  internalType: "address",
                  name: "ownerWallet",
                  type: "address",
                },
                {
                  internalType: "bool",
                  name: "active",
                  type: "bool",
                },
                {
                  internalType: "bool",
                  name: "finished",
                  type: "bool",
                },
                {
                  internalType: "uint256",
                  name: "createdAt",
                  type: "uint256",
                },
                {
                  internalType: "string",
                  name: "category",
                  type: "string",
                },
              ],
              internalType: "struct Campaign[]",
              name: "",
              type: "tuple[]",
            },
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "_id",
              type: "uint256",
            },
          ],
          name: "getCampaign",
          outputs: [
            {
              components: [
                {
                  internalType: "uint256",
                  name: "id",
                  type: "uint256",
                },
                {
                  internalType: "string",
                  name: "title",
                  type: "string",
                },
                {
                  internalType: "string",
                  name: "description",
                  type: "string",
                },
                {
                  internalType: "string[]",
                  name: "imageURLs",
                  type: "string[]",
                },
                {
                  internalType: "uint256",
                  name: "goal",
                  type: "uint256",
                },
                {
                  internalType: "uint256",
                  name: "totalRaised",
                  type: "uint256",
                },
                {
                  internalType: "uint256",
                  name: "platformFee",
                  type: "uint256",
                },
                {
                  internalType: "string",
                  name: "ownerName",
                  type: "string",
                },
                {
                  internalType: "string",
                  name: "ownerContact",
                  type: "string",
                },
                {
                  internalType: "address",
                  name: "ownerWallet",
                  type: "address",
                },
                {
                  internalType: "bool",
                  name: "active",
                  type: "bool",
                },
                {
                  internalType: "bool",
                  name: "finished",
                  type: "bool",
                },
                {
                  internalType: "uint256",
                  name: "createdAt",
                  type: "uint256",
                },
                {
                  internalType: "string",
                  name: "category",
                  type: "string",
                },
              ],
              internalType: "struct Campaign",
              name: "",
              type: "tuple",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "getContractBalance",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "_id",
              type: "uint256",
            },
          ],
          name: "getDonationCount",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "_id",
              type: "uint256",
            },
          ],
          name: "getDonations",
          outputs: [
            {
              components: [
                {
                  internalType: "address",
                  name: "donor",
                  type: "address",
                },
                {
                  internalType: "uint256",
                  name: "amount",
                  type: "uint256",
                },
                {
                  internalType: "uint256",
                  name: "timestamp",
                  type: "uint256",
                },
              ],
              internalType: "struct Donation[]",
              name: "",
              type: "tuple[]",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "_offset",
              type: "uint256",
            },
            {
              internalType: "uint256",
              name: "_limit",
              type: "uint256",
            },
          ],
          name: "getFinishedCampaignsPaginated",
          outputs: [
            {
              components: [
                {
                  internalType: "uint256",
                  name: "id",
                  type: "uint256",
                },
                {
                  internalType: "string",
                  name: "title",
                  type: "string",
                },
                {
                  internalType: "string",
                  name: "description",
                  type: "string",
                },
                {
                  internalType: "string[]",
                  name: "imageURLs",
                  type: "string[]",
                },
                {
                  internalType: "uint256",
                  name: "goal",
                  type: "uint256",
                },
                {
                  internalType: "uint256",
                  name: "totalRaised",
                  type: "uint256",
                },
                {
                  internalType: "uint256",
                  name: "platformFee",
                  type: "uint256",
                },
                {
                  internalType: "string",
                  name: "ownerName",
                  type: "string",
                },
                {
                  internalType: "string",
                  name: "ownerContact",
                  type: "string",
                },
                {
                  internalType: "address",
                  name: "ownerWallet",
                  type: "address",
                },
                {
                  internalType: "bool",
                  name: "active",
                  type: "bool",
                },
                {
                  internalType: "bool",
                  name: "finished",
                  type: "bool",
                },
                {
                  internalType: "uint256",
                  name: "createdAt",
                  type: "uint256",
                },
                {
                  internalType: "string",
                  name: "category",
                  type: "string",
                },
              ],
              internalType: "struct Campaign[]",
              name: "",
              type: "tuple[]",
            },
            {
              internalType: "uint256",
              name: "total",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "_amount",
              type: "uint256",
            },
          ],
          name: "getPlatformFeeForAmount",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "getPlatformFeePercent",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          name: "pendingWithdrawals",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "platformFeePercent",
          outputs: [
            {
              internalType: "uint256",
              name: "",
              type: "uint256",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "platformWallet",
          outputs: [
            {
              internalType: "address",
              name: "",
              type: "address",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
      ];

      async function trackMoneyFlow() {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML =
          '<div style="text-align: center; padding: 30px;">üîÑ Analyzing money flow...</div>';

        try {
          const campaignId = document.getElementById("campaignId").value;
          const contractAddress =
            document.getElementById("contractAddress").value;

          const web3 = new Web3(RPC_URL);
          const contract = new web3.eth.Contract(minimalABI, contractAddress);

          // Get campaign details
          const campaign = await contract.methods
            .getCampaign(campaignId)
            .call();
          const platformWallet = await contract.methods.platformWallet().call();
          const platformFeePercent = await contract.methods
            .platformFeePercent()
            .call();
          const pending = await contract.methods
            .pendingWithdrawals(campaignId)
            .call();
          const contractBalance = await web3.eth.getBalance(contractAddress);

          let html = `
                <div class="flow-item">
                    <h3>üìä Campaign Overview: ${campaign.title}</h3>
                    <table>
                        <tr><td><strong>Campaign ID:</strong></td><td>#${campaignId}</td></tr>
                        <tr><td><strong>Goal:</strong></td><td><span class="amount">${web3.utils.fromWei(
                          campaign.goal,
                          "ether"
                        )} KPGT</span></td></tr>
                        <tr><td><strong>Total Raised:</strong></td><td><span class="amount">${web3.utils.fromWei(
                          campaign.totalRaised,
                          "ether"
                        )} KPGT</span></td></tr>
                        <tr><td><strong>Owner:</strong></td><td><a href="${EXPLORER_URL}/address/${
            campaign.ownerWallet
          }" target="_blank" class="link">${campaign.ownerWallet}</a></td></tr>
                        <tr><td><strong>Is Finished:</strong></td><td>${
                          campaign.finished ? "‚úÖ Yes" : "‚ùå No"
                        }</td></tr>
                        <tr><td><strong>Pending Withdrawals:</strong></td><td><span class="amount">${web3.utils.fromWei(
                          pending,
                          "ether"
                        )} KPGT</span></td></tr>
                    </table>
                </div>

                <div class="flow-item">
                    <h3>‚öôÔ∏è Platform Settings</h3>
                    <table>
                        <tr><td><strong>Platform Wallet:</strong></td><td><a href="${EXPLORER_URL}/address/${platformWallet}" target="_blank" class="link">${platformWallet}</a></td></tr>
                        <tr><td><strong>Platform Fee:</strong></td><td>${
                          platformFeePercent / 100
                        }%</td></tr>
                        <tr><td><strong>Contract Balance:</strong></td><td><span class="amount">${web3.utils.fromWei(
                          contractBalance,
                          "ether"
                        )} KPGT</span></td></tr>
                    </table>
                </div>
                `;

          // Get donation events
          html += "<h3>üí∏ Donation Flow Analysis</h3>";

          try {
            const donationEvents = await contract.getPastEvents(
              "DonationReceived",
              {
                filter: { campaignId: campaignId },
                fromBlock: 0,
                toBlock: "latest",
              }
            );

            if (donationEvents.length > 0) {
              let totalDonated = 0;
              let totalPlatformFees = 0;

              html += `<div class="info"><strong class="success">‚úÖ Found ${donationEvents.length} donation(s)</strong></div>`;

              html +=
                "<table><thead><tr><th>Donor</th><th>Amount</th><th>Platform Fee</th><th>Net to Campaign</th><th>Tx Hash</th></tr></thead><tbody>";

              for (let event of donationEvents) {
                const amount = parseFloat(
                  web3.utils.fromWei(event.returnValues.amount, "ether")
                );
                const fee = parseFloat(
                  web3.utils.fromWei(event.returnValues.platformFee, "ether")
                );
                const netAmount = amount - fee;

                totalDonated += amount;
                totalPlatformFees += fee;

                html += `
                            <tr>
                                <td class="address">${event.returnValues.donor.slice(
                                  0,
                                  8
                                )}...${event.returnValues.donor.slice(-6)}</td>
                                <td class="amount">${amount.toFixed(
                                  4
                                )} KPGT</td>
                                <td style="color: #ff9800;">${fee.toFixed(
                                  4
                                )} KPGT</td>
                                <td style="color: #00e68a;">${netAmount.toFixed(
                                  4
                                )} KPGT</td>
                                <td><a href="${EXPLORER_URL}/tx/${
                  event.transactionHash
                }" target="_blank" class="link">View Tx</a></td>
                            </tr>
                            `;
              }

              html += "</tbody></table>";

              // Summary
              html += `
                        <div class="flow-item">
                            <h3>üìà Money Flow Summary</h3>
                            <div class="money-flow">
                                <div>
                                    <strong>Total Donated:</strong><br>
                                    <span class="amount">${totalDonated.toFixed(
                                      4
                                    )} KPGT</span>
                                </div>
                                <div class="arrow">‚Üí</div>
                                <div>
                                    <strong>Platform Fees:</strong><br>
                                    <span style="color: #ff9800; font-size: 18px; font-weight: bold;">${totalPlatformFees.toFixed(
                                      4
                                    )} KPGT</span><br>
                                    <small>Sent to: <span class="address">${platformWallet}</span></small>
                                </div>
                                <div class="arrow">‚Üí</div>
                                <div>
                                    <strong>Net to Campaign:</strong><br>
                                    <span style="color: #00e68a; font-size: 18px; font-weight: bold;">${(
                                      totalDonated - totalPlatformFees
                                    ).toFixed(4)} KPGT</span>
                                </div>
                            </div>
                        </div>
                        `;
            } else {
              html +=
                '<div class="warning"><strong>‚ö†Ô∏è No donation events found</strong></div>';
            }
          } catch (err) {
            html += `<div class="error"><strong>‚ùå Error fetching donation events:</strong><br>${err.message}</div>`;
          }

          // Check withdrawal events
          html += "<h3>üí∞ Withdrawal Events</h3>";

          try {
            const withdrawEvents = await contract.getPastEvents(
              "FundsWithdrawn",
              {
                filter: { campaignId: campaignId },
                fromBlock: 0,
                toBlock: "latest",
              }
            );

            if (withdrawEvents.length > 0) {
              html += `<div class="info"><strong class="success">‚úÖ Found ${withdrawEvents.length} withdrawal(s)</strong></div>`;

              for (let event of withdrawEvents) {
                const amount = web3.utils.fromWei(
                  event.returnValues.amount,
                  "ether"
                );
                const block = await web3.eth.getBlock(event.blockNumber);
                const date = new Date(block.timestamp * 1000).toLocaleString();

                html += `
                            <div class="flow-item">
                                <div class="money-flow">
                                    <div>
                                        <strong>From Contract</strong><br>
                                        <span class="address">${contractAddress}</span>
                                    </div>
                                    <div class="arrow">‚Üí</div>
                                    <div>
                                        <strong>To Owner</strong><br>
                                        <span class="address">${event.returnValues.to}</span>
                                    </div>
                                    <div class="arrow">‚Üí</div>
                                    <div>
                                        <span class="amount">${amount} KPGT</span>
                                    </div>
                                </div>
                                <table>
                                    <tr><td><strong>Date:</strong></td><td>${date}</td></tr>
                                    <tr><td><strong>Block:</strong></td><td>${event.blockNumber}</td></tr>
                                    <tr><td><strong>Tx Hash:</strong></td><td><a href="${EXPLORER_URL}/tx/${event.transactionHash}" target="_blank" class="link">${event.transactionHash}</a></td></tr>
                                </table>
                            </div>
                            `;
              }

              html += `<div class="info">
                            <strong>‚úÖ SUCCESS: Funds were withdrawn to the campaign owner!</strong><br>
                            Check the owner's wallet balance at: <a href="${EXPLORER_URL}/address/${campaign.ownerWallet}" target="_blank" class="link">${campaign.ownerWallet}</a>
                        </div>`;
            } else {
              if (parseFloat(web3.utils.fromWei(pending, "ether")) > 0) {
                html += `<div class="warning">
                                <strong>‚ö†Ô∏è No withdrawal events found, but ${web3.utils.fromWei(
                                  pending,
                                  "ether"
                                )} KPGT is pending!</strong><br>
                                The auto-withdrawal may have failed. You need to manually withdraw using the withdraw button.
                            </div>`;
              } else {
                html += `<div class="error">
                                <strong>‚ùå MYSTERY: No withdrawal events, but pending = 0</strong><br>
                                This means either:
                                <ul>
                                    <li>The withdrawal happened but event wasn't emitted (contract bug)</li>
                                    <li>Funds went somewhere unexpected</li>
                                    <li>Need to check internal transactions on the blockchain</li>
                                </ul>
                                <strong>Action:</strong> Check the transaction that finished the campaign for internal transfers.
                            </div>`;
              }
            }
          } catch (err) {
            html += `<div class="error"><strong>‚ùå Error fetching withdrawal events:</strong><br>${err.message}</div>`;
          }

          resultDiv.innerHTML = html;
        } catch (err) {
          resultDiv.innerHTML = `<div class="error">
                    <strong>‚ùå Error:</strong><br>${err.message}
                </div>`;
          console.error(err);
        }
      }
    </script>
  </body>
</html>
